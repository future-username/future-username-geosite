name: Build geosite.dat

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - "data/**"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build geosite.dat
        run: |
          mkdir -p publish
          cat > compiler.py << 'EOF'
import struct, os

def write_varint(n):
    out = b""
    while True:
        b = n & 0x7F
        n >>= 7
        if n:
            out += bytes([b | 0x80])
        else:
            out += bytes([b])
            break
    return out

def encode_string(field, text):
    b = text.encode()
    out = bytes([(field << 3) | 2])
    out += write_varint(len(b))
    out += b
    return out

def encode_domain(t, v):
    block = b""
    block += bytes([(1 << 3) | 0]) + write_varint(t)
    block += encode_string(2, v)
    out = bytes([(2 << 3) | 2])
    out += write_varint(len(block))
    out += block
    return out

def encode_entry(name, rules):
    entry = encode_string(1, name)
    for r in rules:
        entry += r
    return bytes([(1 << 3) | 2]) + write_varint(len(entry)) + entry

root = "data"
out = b""

for fn in sorted(os.listdir(root)):
    if fn.startswith("category-") and fn.endswith(".txt"):
        cat = fn[9:-4]
        rules = []
        with open(os.path.join(root, fn)) as f:
            for line in f:
                line = line.strip()
                if not line or line.startswith("#"):
                    continue
                if line.startswith("domain:"):
                    rules.append(encode_domain(2, line[7:]))
                elif line.startswith("full:"):
                    rules.append(encode_domain(0, line[5:]))
                elif line.startswith("regexp:"):
                    rules.append(encode_domain(1, line[7:]))
        out += encode_entry(cat, rules)

with open("publish/geosite.dat", "wb") as f:
    f.write(out)
EOF
          python3 compiler.py

      - name: Hash
        run: |
          cd publish
          sha256sum geosite.dat > geosite.dat.sha256sum

      - name: Push to release branch
        run: |
          cd publish
          git init
          git config --local user.name "github-actions[bot]"
          git config --local user.email "bot@github.com"
          git checkout -b release
          git add .
          git commit -m "Build $(date +%Y%m%d%H%M)"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f -u origin release

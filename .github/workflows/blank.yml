name: Build geosite.dat

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - "data/**"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build geosite.dat
        run: |
          mkdir -p publish

          cat > compiler.py << 'EOF'
import struct, os, zlib

# geosite.dat format used in Xray/V2Ray:
# Every "entry" contains:
# - name
# - repeated domain rules (type + value)

def write_varint(n):
    out = b""
    while True:
        b = n & 0x7F
        n >>= 7
        if n:
            out += struct.pack("B", b | 0x80)
        else:
            out += struct.pack("B", b)
            break
    return out

def encode_string(field_number, text):
    b = text.encode()
    out = struct.pack("B", field_number << 3 | 2)
    out += write_varint(len(b))
    out += b
    return out

def encode_domain(domain_type, value):
    block = b""
    block += struct.pack("B", 1 << 3 | 0)       # field 1: type
    block += write_varint(domain_type)
    block += encode_string(2, value)            # field 2: value
    out = struct.pack("B", 2 << 3 | 2)          # field 2 inside entry
    out += write_varint(len(block))
    out += block
    return out

def encode_entry(name, rules):
    entry = encode_string(1, name)
    for rule in rules:
        entry += rule
    wrapper = struct.pack("B", 1 << 3 | 2)
    wrapper += write_varint(len(entry))
    wrapper += entry
    return wrapper

root = "data"
out = b""

for filename in sorted(os.listdir(root)):
    if not filename.startswith("category-") or not filename.endswith(".txt"):
        continue

    cat = filename[9:-4]
    rules = []
    with open(os.path.join(root, filename)) as f:
        for line in f:
            line = line.strip()
            if not line or line.startswith("#"):
                continue
            if line.startswith("domain:"):
                rules.append(encode_domain(2, line[7:]))
            elif line.startswith("full:"):
                rules.append(encode_domain(0, line[5:]))
            elif line.startswith("regexp:"):
                rules.append(encode_domain(1, line[7:]))

    out += encode_entry(cat, rules)

with open("publish/geosite.dat", "wb") as f:
    f.write(out)

EOF

          python3 compiler.py

      - name: Hash
        run: |
          cd publish
          sha256sum geosite.dat > geosite.dat.sha256sum

      - name: Push to release branch
        run: |
          cd publish
          git init
          git config --local user.name "github-actions[bot]"
          git config --local user.email "bot@github.com"
          git checkout -b release
          git add .
          git commit -m "Auto build $(date +%Y%m%d%H%M)"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f -u origin release
